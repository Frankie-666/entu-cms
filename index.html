<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Entu CMS</title>
        <style media="screen">
            body {
                height: 100%;
                padding: 0px;
                font-family: -apple-system, 'Helvetica Neue', Verdana, ariel, sans-serif;
                font-weight: 200;
                letter-spacing: 0.4px;
                color: #182530;
                -webkit-app-region: drag;
            }
            h1 {
                margin: 40px 0px 0px 0px;
                padding: 0px;
                font-size: 40px;
                font-weight: 100;
                line-height: 40px;
                text-align: center;
            }
            h2 {
                margin: 30px 0px 40px 0px;
                padding: 0px;
                font-size: 16px;
                font-weight: 100;
                line-height: 16px;
                text-align: center;
                text-overflow: ellipsis;
            }
            pre {
                margin: 0px;
                padding: 10px 0px 0px 0px;
            }
            footer {
                position: fixed;
                left: 0px;
                bottom: 0px;
                width: 320px;
                padding: 10px 0px;
                text-align: center;
                font-size: 12px;
                line-height: 12px;
                font-weight: 100;
                background: #F4F4F4;
                -webkit-app-region: drag;
                -webkit-user-select: none;
                user-select: none;
                cursor: default;
            }
            #tools {
                position: fixed;
                top: 0px;
                left: 0px;
                bottom: 0px;
                width: 320px;
                background: #F4F4F4;
                -webkit-app-region: drag;
                -webkit-user-select: none;
                user-select: none;
                cursor: default;
            }
            #log {
                position: fixed;
                top: 0px;
                right: 0px;
                bottom: 30px;
                left: 320px;
                padding: 2px;
                font-size: 12px;
                line-height: 14px;
                overflow: scroll;
            }
            #log table {
                width: 100%;
            }
            #log-table tr:hover {
                background: #F4F4F4;
            }
            #log-table td {
                margin: 0px;
                padding: 5px 10px;
                vertical-align: top;
            }
            #log-table a {
                color: inherit;
                text-decoration: none;
            }
            #log-table a:hover {
                color: #182530;
                text-decoration: underline;
            }
            #log-table .log {
                white-space: nowrap;
            }
            #log-table .error {
                color: red;
            }
            #log-clear {
                position: fixed;
                right: 0px;
                bottom: 0px;
                left: 320px;
                padding: 10px 0px;
                text-align: center;
                font-size: 12px;
                line-height: 12px;
                font-weight: 100;
                background: #ffffff;
                -webkit-app-region: drag;
                -webkit-user-select: none;
                user-select: none;
                cursor: default;
            }
            #log-clear a {
                color: #182530;
                text-decoration: none;
            }
            #log-clear a:hover {
                color: #182530;
                font-weight: bold;
            }
            .button {
                display: block;
                width: 250px;
                margin: 0px auto 10px auto;
                padding: 10px;
                text-align: center;
                text-decoration: none;
                font-size: 14px;
                line-height: 20px;
                color: #A4A9AD;
                background: #ffffff;
                border: 1px solid #A4A9AD;
                z-index: 100;
            }
            .button:hover {
                color: #182530;
                border: 1px solid #182530;
            }
            .button span {
                display: block;
                text-align: center;
                font-size: 11px;
                font-weight: 100;
                line-height: 16px;
                color: #909090;
            }
        </style>
    </head>
    <body>
        <div id="tools">
            <h1>Entu CMS</h1>

            <h2 id="title"></h2>

            <a class="button" href="javascript:shell.openExternal(serverUrl)">Preview webpage<span id="preview"></span></a>
            <a class="button" href="javascript:shell.showItemInFolder(appConf.source)">Open source folder<span id="source"></span></a>
            <a class="button" href="javascript:shell.showItemInFolder(appConf.build)">Open build folder<span id="build"></span></a>
        </div>
        <div id="log">
            <table cellspacing=0>
                <tbody id="log-table">

                </tbody>
            </table>
        </div>
        <div id="log-clear">
            <a href="javascript:clearLog()">clear log</a>
        </div>

        <footer id="footer"></footer>
    </body>

    <script>
        const {remote} = require('electron')
        const {app, dialog, shell} = remote
        const renderer = require('./renderer.js')
        const async = require('async')

        var confFile = ''
        var appConf = {}
        var serverUrl = ''

        document.getElementById('footer').innerHTML = app.getVersion()

        async.waterfall([
            function(callback) {
                files = dialog.showOpenDialog({
                    properties: ['openFile'],
                    filters: [
                        {name: 'Yaml files', extensions: ['yaml']}
                    ]
                })
                if(!files) { app.quit() }
                callback(null, files[0])
            },
            function(file, callback) {
                confFile = file
                renderer.openConfFile(confFile, callback)
            },
            function(conf, callback) {
                appConf = conf
                document.getElementById('title').innerHTML = confFile.replace(app.getPath('home'), '~')
                document.getElementById('source').innerHTML = appConf.source.replace(app.getPath('home'), '~')
                document.getElementById('build').innerHTML = appConf.build.replace(app.getPath('home'), '~')
                renderer.startServer(callback)
            },
            function(callback) {
                serverUrl = `http://localhost:${appConf.port}`
                document.getElementById('preview').innerHTML = serverUrl

                let myNotification = new Notification('Entu CMS', {
                    body: `Server started at ${serverUrl}`
                })
                myNotification.onclick = () => {
                    shell.openExternal(serverUrl)
                }

                callback(null)
            }
        ], function(err) {
            if(err) {
                dialog.showMessageBox({
                    type: 'error',
                    message: err.toString(),
                    buttons: ['OK']
                }, function() {
                    app.quit()
                })
            } else {
                renderer.watchFiles(function(err, data) {
                    var log = document.getElementById('log-table')
                    if (err) {
                        log.innerHTML = log.innerHTML + `
                            <tr class="error">
                                <td>${err.event}</td>
                                <td colspan="3">
                                    <a href="javascript:shell.showItemInFolder('${appConf.source+err.source}')">${err.source}</a><br>
                                    <pre>${err.error.toString()}<pre>
                                </td>
                            </tr>
                        `
                    } else {
                        for (var i = 0; i < data.build.length; i++) {
                            log.innerHTML = log.innerHTML + `
                                <tr class="log">
                                    <td>${data.event}</td>
                                    <td><a href="javascript:shell.showItemInFolder('${appConf.source+data.source}')">${data.source}</a></td>
                                    <td><a href="javascript:shell.openExternal('${serverUrl+data.build[i].replace('index.html', '')}')">${data.build[i].replace('/index.html', '')}</a></td>
                                    <td width="100%"></td>
                                </tr>
                            `
                        }
                    }
                    document.getElementById('log').scrollTop = document.getElementById('log').scrollHeight
                })
            }
        })

        document.addEventListener('keydown', function (e) {
    		if (e.which === 123) {
    			remote.getCurrentWindow().toggleDevTools()
    		} else if (e.which === 116) {
    			location.reload()
    		}
    	})

        var clearLog = function() {
            document.getElementById('log-table').innerHTML = ''
        }
    </script>
</html>
